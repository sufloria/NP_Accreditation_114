import streamlit as st
import json
import os

st.set_page_config(page_title="114å¹´å°ˆå¸«èªå®šè‡ªæª¢ç³»çµ±-å®Œæ•´ç‰ˆ", layout="wide")

# 1. å®Œæ•´è³‡æ–™åº«ï¼šåŒ…å« 23 é …æ¢æ–‡ã€ä½è­‰æ¸…å–®èˆ‡è¨ªè«‡é¡Œ 
def get_full_criteria():
    return [
        # ç¬¬ä¸€ç« ï¼šæ•™å­¸è³‡æºèˆ‡çµ„ç¹”ç®¡ç† (1.1.1 - 1.2.3) [cite: 104-153]
        {"id": "1.1.1", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "å°ˆè²¬åŸ¹è‚²èˆ‡ç®¡ç†å–®ä½", "c_level": "å‰¯é™¢é•·ç´šå¬é›†äººï¼Œé†«è­·å…±åŒçµ„æˆï¼Œæ¯3å€‹æœˆé–‹æœƒ1æ¬¡ï¼Œæ¯å¹´è‡³å°‘4æ¬¡ [cite: 104, 256]ã€‚", "check": ["çµ„ç¹”æ¶æ§‹åœ–(å«å‰¯é™¢é•·ã€å°ˆå¸«ä»£è¡¨) [cite: 104]", "æœƒè­°ç´€éŒ„(è¿‘ä¸€å¹´4ä»½) [cite: 104]", "å‹å‹•æ¬Šç›Šç¶­è­·æªæ–½ [cite: 104]"], "q": "å§”å“¡å•ï¼šä½ å€‘å§”å“¡æœƒå¤šä¹…é–‹ä¸€æ¬¡æœƒï¼Ÿå°ˆå¸«ä»£è¡¨æ˜¯å¦æœ‰åˆ—å¸­ï¼Ÿ [cite: 256]"},
        {"id": "1.1.2", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "åŸ·æ¥­å…§å®¹è¨‚å®šèˆ‡å…¬å‘Š", "c_level": "è¨‚å®šåˆ†ç§‘åŸ·è¡Œé …ç›®åŠç‰¹å®šè¨“ç·´ï¼Œå…¬å‘Šå‘¨çŸ¥ä¸¦ç¢ºå¯¦åŸ·è¡Œ [cite: 115, 256]ã€‚", "check": ["å„åˆ†ç§‘åŸ·æ¥­ç¯„åœè¦ç¯„ [cite: 115]", "å·¥ä½œå¥‘ç´„æ›¸(æˆ–å¯¦è³ªæˆæ¬Šæ–‡ä»¶) [cite: 115]", "é†«é™¢å…¬å‘Šå‘¨çŸ¥è­‰æ˜ [cite: 115]"], "q": "å§”å“¡å•ï¼šå¦‚ä½•ç¢ºèªå°ˆå¸«åŸ·è¡Œçš„æ¥­å‹™ç¬¦åˆæœ€æ–°è¾¦æ³•ä¹‹é™„è¡¨ç¯„åœï¼Ÿ [cite: 256]"},
        {"id": "1.1.3", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "é ç«‹é†«ç™‚æµç¨‹(PMP) SOP", "c_level": "æˆç«‹å§”å“¡æœƒï¼Œç›£ç£é†«å¸«é ˆæ–¼24å°æ™‚å…§å®Œæˆæ ¸å°åŠç°½ç½² [cite: 121, 266]ã€‚", "check": ["é ç«‹é†«ç™‚æµç¨‹ SOP [cite: 121]", "24å°æ™‚å…§æ ¸ç°½ç´€éŒ„ [cite: 121]", "å§”å“¡æœƒåå–® [cite: 121]"], "q": "å§”å“¡å•ï¼šåŸ·è¡Œ PMP å¾Œï¼Œç›£ç£é†«å¸«æ˜¯å¦åœ¨ 24 å°æ™‚å…§è£œç°½åï¼Ÿ [cite: 266]"},
        {"id": "1.1.4", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "ç—…æ­·æ›¸å¯«å¯©æŸ¥æ©Ÿåˆ¶", "c_level": "ä¸»æ²»é†«å¸«å°å°ˆå¸«ç—…æ­·è¨˜è¼‰çµ¦äºˆæŒ‡å° [cite: 127, 275]ã€‚", "check": ["ç—…æ­·æ›¸å¯«å¯©æŸ¥æ©Ÿåˆ¶è¦ç¯„ [cite: 127]", "é†«å¸«æŒ‡å°ç—•è·¡æˆ–å¯©æŸ¥åŸ·è¡Œç´€éŒ„ [cite: 127]"], "q": "å§”å“¡å•ï¼šä¸»æ²»é†«å¸«å¦‚ä½•å°ä½ çš„ç—…æ­·è¨˜è¼‰çµ¦äºˆå…·é«”æŒ‡å°ï¼Ÿ [cite: 275]"},
        {"id": "1.1.5", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "è‡¨åºŠåŸ·æ¥­å“è³ªç›£æ¸¬", "c_level": "ä¾åŸ·æ¥­ç¯„ç–‡èˆ‡å¥‘ç´„è¨‚æœ‰å“è³ªç›£æ¸¬è¦ç¯„åŠæ©Ÿåˆ¶ [cite: 131, 275]ã€‚", "check": ["åŸ·æ¥­å“è³ªç›£æ¸¬è¾¦æ³• [cite: 131]", "å…·é«”ç›£æ¸¬æŒ‡æ¨™èˆ‡é‹ä½œæƒ…å½¢ [cite: 131]"], "q": "å§”å“¡å•ï¼šé†«é™¢å¦‚ä½•ç›£æ¸¬å°ˆå¸«çš„åŸ·æ¥­å“è³ªï¼Ÿ [cite: 275]"},
        {"id": "1.1.6", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "å°ˆç§‘è­·ç†å¸«è€ƒæ ¸æ©Ÿåˆ¶", "c_level": "è¨‚æœ‰è€ƒæ ¸æ©Ÿåˆ¶ä¸”ç”±é†«è­·éƒ¨é–€å…±åŒè² è²¬ [cite: 135, 275]ã€‚", "check": ["å°ˆç§‘è­·ç†å¸«è€ƒæ ¸è¦ç¯„ [cite: 135]", "é†«è­·å…±åŒè€ƒæ ¸ä¹‹ç´€éŒ„ [cite: 135]"], "q": "å§”å“¡å•ï¼šå°ˆå¸«è€ƒæ ¸æ˜¯å¦ç”±é†«è­·é›™æ–¹å…±åŒé€²è¡Œï¼Ÿ [cite: 275]"},
        {"id": "1.2.1", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "å¦¥é©çš„è¨“ç·´å ´æ‰€", "c_level": "æä¾›å…¼é¡§éš±ç§ã€å®‰å…¨èˆ‡å­¸ç¿’ä¾¿åˆ©æ€§ä¹‹å ´æ‰€ [cite: 140, 275]ã€‚", "check": ["è‡¨åºŠè¨“ç·´å ´æ‰€åŠç©ºé–“ [cite: 140]", "å·¥ä½œå®‰å…¨èˆ‡å¥åº·ç…§è­·ç­–ç•¥ [cite: 140]"], "q": "å§”å“¡å•ï¼šå¯¦åœ°è¨ªè¦–æ™‚ï¼Œè«‹æŒ‡å¼•ç›¸é—œæ•™å­¸ç©ºé–“èˆ‡è¨­æ–½ã€‚ [cite: 275]"},
        {"id": "1.2.2", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "å¿…é ˆä¹‹è¨“ç·´è¨­å‚™", "c_level": "æä¾›è¨“ç·´æ‰€éœ€è¨­å‚™(å¦‚ç¶²è·¯å­¸ç¿’å¹³å°ã€æ–‡ç»æª¢ç´¢) [cite: 145, 285]ã€‚", "check": ["è¨“ç·´ç›¸é—œè¨­å‚™èˆ‡ç’°å¢ƒ [cite: 145]", "ç¶²è·¯å­¸ç¿’å¹³å°èˆ‡æª¢ç´¢ç³»çµ±åŠŸèƒ½ [cite: 145]"], "q": "å§”å“¡å•ï¼šè‡¨åºŠä¸Šæ˜¯å¦æœ‰è¶³å¤ çš„ç¡¬é«”èˆ‡è³‡æ–™åº«ä¾›å­¸ç¿’ï¼Ÿ [cite: 285]"},
        {"id": "1.2.3", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "åœ–æ›¸èˆ‡æœŸåˆŠç®¡ç†", "c_level": "æä¾›é†«å€«ã€æ³•å¾‹ã€å¯¦è­‰ç­‰è¿‘5å¹´å…§åœ–æ›¸åŠæœŸåˆŠ [cite: 149, 285]ã€‚", "check": ["è³‡æºæ¸…å–®(å«é›»å­ç‰ˆ) [cite: 149]", "æ–°è³¼å…¥åœ–æ›¸å…¬å‘Šèˆ‡ç®¡ç†è¦å‰‡ [cite: 149]"], "q": "å§”å“¡å•ï¼šä½ çŸ¥é“å¦‚ä½•æŸ¥è©¢é†«é™¢æ–°è³¼å…¥çš„åœ–æ›¸æˆ–æœŸåˆŠå—ï¼Ÿ [cite: 285]"},

        # ç¬¬äºŒç« ï¼šæ•™å­¸å¸«è³‡ã€åŸ¹è‚²èˆ‡ç¹¼çºŒæ•™è‚² (2.1.1 - 2.2.3) [cite: 155-190]
        {"id": "2.1.1", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å¸«è³‡-é†«å¸«è³‡æ ¼", "c_level": "å…·å°ˆç§‘é†«å¸«è³‡æ ¼ä¸”å¾äº‹å°ˆç§‘å·¥ä½œè‡³å°‘2å¹´ [cite: 155, 296]ã€‚", "check": ["é†«å¸«è­‰æ›¸å½±æœ¬ [cite: 155]", "æœå‹™è­‰æ˜èˆ‡å¹´è³‡ [cite: 155]"], "q": "å§”å“¡å•ï¼šåƒèˆ‡åŸ¹è¨“çš„æŒ‡å°é†«å¸«æ˜¯å¦æœ‰ 2 å¹´ä»¥ä¸Šçš„å°ˆç§‘è³‡æ­·ï¼Ÿ [cite: 296]"},
        {"id": "2.1.2", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å¸«è³‡-å°ˆå¸«è³‡æ ¼", "c_level": "å…·å°ˆå¸«è³‡æ ¼ä¸”å¾äº‹å°ˆå¸«å·¥ä½œè‡³å°‘2å¹´ [cite: 160, 296]ã€‚", "check": ["å°ˆå¸«è­‰æ›¸å½±æœ¬ [cite: 160]", "å°ˆå¸«æœå‹™å¹´è³‡è­‰æ˜ [cite: 160]"], "q": "å§”å“¡å•ï¼šæ“”ä»»æ•™å¸«çš„å°ˆå¸«æ˜¯å¦éƒ½å…·å‚™ç›¸é—œè­‰ç…§ä¸”å·¥ä½œæ»¿ 2 å¹´ï¼Ÿ [cite: 296]"},
        {"id": "2.1.3", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å¸«è³‡é…ç½®æ¯”èˆ‡å“è³ª", "c_level": "é†«å¸«:å°ˆå¸«:å­¸å“¡æ¯”ä¾‹é ˆç¬¦åˆ 1:4:4 [cite: 165, 296]ã€‚", "check": ["è‡¨åºŠå¸«è³‡èˆ‡å­¸å“¡é…ç½®æ¯”ä¾‹è¡¨ [cite: 165]", "å¸«è³‡è©•å€¼æ•™å­¸æˆæ•ˆç´€éŒ„ [cite: 165]"], "q": "å§”å“¡å•ï¼šç›®å‰è‡¨åºŠä¸Šè€å¸«è·Ÿå­¸å“¡çš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ [cite: 296]"},
        {"id": "2.2.1", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å…·é«”å¸«è³‡åŸ¹è‚²åˆ¶åº¦", "c_level": "æ˜è¨‚æ•™å¸«åŸ¹è‚²åˆ¶åº¦èˆ‡ç™¼å±•è¨ˆç•« [cite: 172, 303]ã€‚", "check": ["å¸«è³‡ç™¼å±•è¨ˆç•« [cite: 172]", "æ•™å¸«åƒèˆ‡é€²ä¿®è¨“ç·´æ´»å‹•ç´€éŒ„ [cite: 172]"], "q": "å§”å“¡å•ï¼šé†«é™¢å¦‚ä½•æ”¯æŒä½ å€‘æå‡æ•™å­¸æŠ€å·§æˆ–æ’°å¯« OSCE æ•™æ¡ˆï¼Ÿ [cite: 303]"},
        {"id": "2.2.2", "is_mandatory": False, "chapter": "ç¬¬äºŒç« ", "title": "å¸«è³‡æ•™å­¸èƒ½åŠ›æå‡", "c_level": "è‡¨åºŠæ•™å¸«åƒèˆ‡èª²ç¨‹è‡³å°‘4å°æ™‚ï¼Œåƒèˆ‡ç‡é”100% [cite: 177, 309]ã€‚", "check": ["æ•™å¸«åƒèˆ‡æ•™å­¸èª²ç¨‹ç´€éŒ„ [cite: 177]", "èª²å¾Œæˆæ•ˆè©•ä¼°èˆ‡æª¢è¨ [cite: 177]"], "q": "å§”å“¡å•ï¼šä½ ä»Šå¹´åƒåŠ äº†å“ªäº›æ•™å­¸èƒ½åŠ›æå‡çš„è¨“ç·´ï¼Ÿå¹¾å°æ™‚ï¼Ÿ [cite: 309]"},
        {"id": "2.2.3", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å°ˆå¸«ç¹¼çºŒæ•™è‚²è¨“ç·´", "c_level": "è¦åŠƒæ¯å¹´è‡³å°‘è¾¦ç†20å°æ™‚æ•™è‚²èª²ç¨‹ [cite: 186, 316]ã€‚", "check": ["å¹´åº¦èª²ç¨‹è¨ˆç•«æ¸…å–® [cite: 186]", "å°ˆå¸«æ™‚æ•¸çµ±è¨ˆèˆ‡é€²éšåˆ¶åº¦ [cite: 186]"], "q": "å§”å“¡å•ï¼šé†«é™¢æ˜¯å¦æœ‰æä¾›è¶³å¤ çš„å­¸åˆ†æˆ–èª²ç¨‹ç¶­æŒå°ˆå¸«è­‰ç…§ï¼Ÿ [cite: 316]"},

        # ç¬¬ä¸‰ç« ï¼šæ•™å­¸è¨“ç·´è¨ˆç•«èˆ‡åŸ·è¡Œæˆæœ (3.1.1 - 3.3.4) [cite: 192-234]
        {"id": "3.1.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´è¨ˆç•«å…§å®¹å…·é«”", "c_level": "å«ç›®çš„ã€ç›®æ¨™ã€èª²ç¨‹ã€å“è³ªç¶­è­·èˆ‡ç›£æ¸¬ [cite: 192, 320]ã€‚", "check": ["å¹´åº¦æ•™å­¸è¨ˆç•«æ›¸ [cite: 192]", "è¨ˆç•«è¨è«–æˆ–ä¿®è¨‚ç´€éŒ„ [cite: 192]"], "q": "å§”å“¡å•ï¼šè«‹ç°¡å–®èªªæ˜è¨“ç·´è¨ˆç•«å¦‚ä½•ç¢ºä¿æ•™å­¸å“è³ªï¼Ÿ [cite: 320]"},
        {"id": "3.1.2", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "æ•™å­¸èª²ç¨‹å…§å®¹å®‰æ’", "c_level": "ä¾èƒ½åŠ›å®‰æ’èª²ç¨‹ä¸¦å…¼é¡§å­¸ç¿’èˆ‡å·¥ä½œéœ€æ±‚ [cite: 199, 320]ã€‚", "check": ["æ•™å­¸æ´»å‹•æ™‚ç¨‹è¡¨ [cite: 199]", "è£œè¨“æªæ–½èˆ‡åæ˜ ç®¡é“ç´€éŒ„ [cite: 199]"], "q": "å§”å“¡å•ï¼šå­¸å“¡çš„å·¥ä½œé‡æ˜¯å¦æœƒå½±éŸ¿åˆ°ä¸Šèª²é€²åº¦ï¼Ÿå¦‚ä½•è£œèª²ï¼Ÿ [cite: 320]"},
        {"id": "3.2.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´èª²ç¨‹ç¬¦åˆæ³•è¦", "c_level": "èª²ç¨‹æ‡‰ç¬¦åˆå°ˆç§‘è­·ç†å¸«åˆ†ç§‘åŠç”„å¯©è¾¦æ³•è¦å®š [cite: 205, 327]ã€‚", "check": ["èª²ç¨‹èˆ‡æ³•è¦å°æ‡‰æ¸…å–® [cite: 205]", "å®šæœŸæª¢è¨åŸ·è¡Œæˆæ•ˆç´€éŒ„ [cite: 205]"], "q": "å§”å“¡å•ï¼šä½ å€‘å¦‚ä½•æ ¸å°ç›®å‰çš„èª²ç¨‹æœ‰åŒ…å«æ³•è¦è¦æ±‚çš„è¨“ç·´ï¼Ÿ [cite: 327]"},
        {"id": "3.2.2", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è‡¨åºŠå¯¦å‹™è¨“ç·´è½å¯¦", "c_level": "åæ˜ å­¸ç¿’ç›®æ¨™ï¼Œä¸¦å…·æª¢è¨æ”¹å–„æ©Ÿåˆ¶ [cite: 211, 327]ã€‚", "check": ["è‡¨åºŠè¨“ç·´åŸ·è¡Œç´€éŒ„ [cite: 211]", "æ”¹å–„èˆ‡æª¢è¨ä¹‹æŒçºŒè­‰æ“š [cite: 211]"], "q": "å§”å“¡å•ï¼šè€å¸«å¦‚ä½•åœ¨è‡¨åºŠä¸Šç¢ºèªä½ çš„å­¸ç¿’æˆæ•ˆï¼Ÿ [cite: 327]"},
        {"id": "3.3.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "å›é¥‹æ©Ÿåˆ¶èˆ‡åæ˜ ç®¡é“", "c_level": "æ•™å¸«å³æ™‚å›é¥‹ä¸¦è¨˜éŒ„ï¼Œè¨­æœ‰ç®¡é“ç¶­è­·æ¬Šç›Š [cite: 216, 327]ã€‚", "check": ["æ•™å¸«è¼”å°èˆ‡å›é¥‹ç´€éŒ„ [cite: 216]", "åæ˜ å•é¡Œç®¡é“èˆ‡æºé€šè­‰æ˜ [cite: 216]"], "q": "å§”å“¡å•ï¼šå¦‚æœä½ åœ¨è¨“ç·´æ™‚é‡åˆ°ä¸åˆç†å¾…é‡ï¼Œæœ‰ä»€éº¼ç”³è¨´çª—å£ï¼Ÿ [cite: 327]"},
        {"id": "3.3.2", "is_mandatory": False, "chapter": "ç¬¬ä¸‰ç« ", "title": "æ•™å¸«å¤šå…ƒåŒ–è©•ä¼°", "c_level": "è¨‚æœ‰è©•ä¼°æ•™å­¸æˆæ•ˆæ©Ÿåˆ¶ä¸¦å¯¦éš›åŸ·è¡Œ [cite: 220, 335]ã€‚", "check": ["è©•ä¼°æ•™å¸«æ©Ÿåˆ¶æ–‡ä»¶ [cite: 220]", "å›é¥‹èˆ‡è¼”å°æ”¹å–„ç´€éŒ„ [cite: 220]"], "q": "å§”å“¡å•ï¼šä½ å€‘å¦‚ä½•è©•åƒ¹æ•™å­¸å°å¸«ï¼Ÿçµæœæœƒçµ¦äºˆè¼”å°å—ï¼Ÿ [cite: 335]"},
        {"id": "3.3.3", "is_mandatory": False, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´æˆæœåˆ†ææ”¹å–„", "c_level": "å¤šå…ƒç®¡é“è©•ä¼°å­¸å“¡çµæœä¸¦é€²è¡Œåˆ†æèˆ‡è¼”å° [cite: 228, 335]ã€‚", "check": ["è¨“ç·´æˆæœåˆ†æå ±å‘Š [cite: 228]", "æˆæœä¸ä½³å­¸å“¡ä¹‹è¼”å°æ©Ÿåˆ¶ [cite: 228]"], "q": "å§”å“¡å•ï¼šå¦‚æœå­¸å“¡å­¸ç¿’æˆæ•ˆä¸ç†æƒ³ï¼Œé†«é™¢æœƒæ€éº¼è™•ç†ï¼Ÿ [cite: 335]"},
        {"id": "3.3.4", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´è¨ˆç•«æˆæ•ˆè©•ä¼°", "c_level": "è¨‚æœ‰å…·é«”è©•å€¼è¨ˆç•«ä¸”æ¯å¹´æª¢è¨(å«è€ƒç…§ç‡) [cite: 232, 344]ã€‚", "check": ["è¨ˆç•«è©•å€¼åˆ†æå ±å‘Š [cite: 232]", "å¹´åº¦è€ƒç…§é€šéç‡çµ±è¨ˆ [cite: 232]"], "q": "å§”å“¡å•ï¼šå»å¹´è€ƒç…§ç‡å¦‚ä½•ï¼Ÿæœ‰æ ¹æ“šçµæœèª¿æ•´æ•™å­¸å—ï¼Ÿ [cite: 344]"}
    ]

# 2. é€²åº¦å­˜å–é‚è¼¯
SAVE_FILE = 'progress.json'
def load_progress():
    if os.path.exists(SAVE_FILE):
        try:
            with open(SAVE_FILE, 'r', encoding='utf-8') as f: return json.load(f)
        except: return {}
    return {}

def save_progress(progress):
    with open(SAVE_FILE, 'w', encoding='utf-8') as f: json.dump(progress, f, ensure_ascii=False)

# --- ä»‹é¢å‘ˆç¾ ---
st.title("ğŸ›¡ï¸ 114å¹´åº¦å°ˆç§‘è­·ç†å¸«è¨“ç·´é†«é™¢èªå®š-çµ‚æ¥µè‡ªæª¢ç³»çµ±")

data = get_full_criteria()
saved_progress = load_progress()
user_data = {}

st.sidebar.header("ğŸ“Š èªå®šåˆ¤å®šçµæœ")

tab_chk, tab_time = st.tabs(["ğŸ“‹ æ¢æ–‡èˆ‡ä½è­‰(å«ç´°é …é€£çµ)", "â±ï¸ è¨ªè¦–æ™‚ç¨‹è¡¨"])

with tab_chk:
    for chap_name in ["ç¬¬ä¸€ç« ", "ç¬¬äºŒç« ", "ç¬¬ä¸‰ç« "]:
        st.subheader(f"ğŸ“ {chap_name}")
        chap_data = [d for d in data if d['chapter'] == chap_name]
        
        for item in chap_data:
            badge = " (å¿…)" if item['is_mandatory'] else ""
            with st.expander(f"{item['id']} {item['title']}{badge}"):
                st.write(f"**ã€Cç­‰ç´šæ¨™æº–ã€‘**ï¼š{item['c_level']}")
                st.warning(f"ğŸ¤ {item['q']}")
                
                old_item_data = saved_progress.get(item['id'], {})
                
                # è² è²¬äººé¸æ“‡èˆ‡æ‰‹å‹•è¼¸å…¥
                roles = ["æœªæŒ‡æ´¾", "è¡Œæ”¿çµ„", "æ•™å­¸çµ„", "è‡¨åºŠçµ„", "å­¸è¡“çµ„é•·", "å…¶ä»–"]
                saved_res = old_item_data.get("res", "æœªæŒ‡æ´¾")
                def_idx = roles.index(saved_res) if saved_res in roles else 5
                
                c1, c2 = st.columns([1, 1])
                with c1:
                    sel_role = st.selectbox(f"ğŸ‘¤ è² è²¬äºº ({item['id']})", roles, index=def_idx, key=f"sel_{item['id']}")
                    final_res = sel_role
                    if sel_role == "å…¶ä»–" or (saved_res and saved_res not in roles):
                        final_res = st.text_input("âœï¸ å¡«å¯«å§“å", value=saved_res if saved_res not in roles else "", key=f"res_{item['id']}")
                
                # ---------------------------------------------------------
                # ä½è­‰æ¸…å–®ã€æ ¸å–æ–¹å¡Šèˆ‡å°ˆå±¬é€£çµ 
                # ---------------------------------------------------------
                st.write("**ğŸ“‘ ä½è­‰ç´°é …é€£çµæ ¸å°ï¼š**")
                chk_results = []
                chk_links = old_item_data.get("links", {})
                
                for i, chk_text in enumerate(item['check']):
                    col_chk, col_link, col_btn = st.columns([3, 4, 2])
                    
                    with col_chk:
                        # å‹¾é¸æ¡†
                        is_checked = st.checkbox(chk_text, key=f"chk_{item['id']}_{i}", value=old_item_data.get("checks", [False]*10)[i] if i < len(old_item_data.get("checks", [])) else False)
                        chk_results.append(is_checked)
                    
                    with col_link:
                        # é€£çµè¼¸å…¥
                        link_val = st.text_input("URL", value=chk_links.get(str(i), ""), key=f"lnk_{item['id']}_{i}", label_visibility="collapsed", placeholder="è²¼ä¸Šä½è­‰é€£çµ")
                        chk_links[str(i)] = link_val
                    
                    with col_btn:
                        # è·³è½‰æŒ‰éˆ•
                        if link_val: st.link_button("ğŸ“‚ é–‹å•Ÿ", link_val, use_container_width=True)
                
                # è©•åˆ†ç­‰ç´š
                st.divider()
                saved_score = old_item_data.get("score", "D")
                score_idx = ["A", "B", "C", "D"].index(saved_score)
                current_score = st.radio("è‡ªè©•ç­‰ç´š", ["A", "B", "C", "D"], index=score_idx, key=f"r_{item['id']}", horizontal=True)
                
                user_data[item['id']] = {
                    "res": final_res, 
                    "score": current_score,
                    "checks": chk_results,
                    "links": chk_links
                }

    if st.button("ğŸ’¾ å„²å­˜æ‰€æœ‰é€²åº¦"):
        save_progress(user_data)
        st.toast("é€²åº¦å·²æˆåŠŸå­˜æª”ï¼")

with tab_time:
    st.info("ğŸ•’ è¨ªè¦–ç•¶å¤©æµç¨‹ç¸½è¨ˆ 3.5 å°æ™‚ [cite: 50-51]ï¼š")
    schedule = [
        {"ç¨‹åº": "æœƒå‰æœƒ", "åˆ†é˜": "20", "èªªæ˜": "è¨ªè¦–å§”å“¡å…ˆè¡Œæºé€šå…±è­˜ [cite: 51]"},
        {"ç¨‹åº": "è‡´è©èˆ‡ç°¡å ±", "æ™‚é–“": "20", "èªªæ˜": "è‡´è© 5min + é†«é™¢ç°¡å ± 15min [cite: 51]"},
        {"ç¨‹åº": "å¯¦åœ°/æ›¸å¯©/è¨ªè«‡", "æ™‚é–“": "130", "èªªæ˜": "æ–‡ä»¶å¯©æŸ¥ã€è‡¨åºŠè§€å¯Ÿã€äººå“¡è¨ªè«‡ [cite: 51]"},
        {"ç¨‹åº": "æ„è¦‹äº¤æµèˆ‡å›é¥‹", "æ™‚é–“": "10", "èªªæ˜": "æå‡ºåˆæ­¥å›é¥‹å»ºè­°ï¼Œå¯è£œå……è³‡æ–™ [cite: 51]"}
    ]
    st.table(schedule)

# 3. åˆ¤å®šé‚è¼¯åˆ¤å®š [cite: 68-70, 97-99]
total_count = len(data)
passed_count = sum(1 for d in user_data.values() if d['score'] in ['A', 'B', 'C'])
pass_rate = (passed_count / total_count) * 100
mandatory_failed = [id for id, d in user_data.items() if any(i['id'] == id and i['is_mandatory'] for i in data) and d['score'] == 'D']

st.sidebar.metric("ç›®å‰ç¸½é”æˆç‡", f"{pass_rate:.1f}%")
if mandatory_failed:
    st.sidebar.error(f"âŒ ä¸åˆæ ¼ï¼šå¿…è¦é … D ({', '.join(mandatory_failed)})")
    st.sidebar.write("âš ï¸ å¿…è¦é …é ˆ 100% é” C ç­‰ç´šä»¥ä¸Š [cite: 70] ã€‚")
elif pass_rate >= 90:
    st.sidebar.success("âœ… ç¬¦åˆé€šéæ¨™æº–")
else:
    st.sidebar.warning(f"âš ï¸ é”æˆç‡æœªæ»¿ 90% (éœ€é” 90%) [cite: 69] ã€‚")

st.sidebar.divider()
st.sidebar.info("ğŸ’¡ é€šéæ¨™æº–ï¼šCä»¥ä¸Šé” 90% ä¸”å¿…è¦é …å…¨æ•¸é€šé [cite: 68-70] ã€‚")
