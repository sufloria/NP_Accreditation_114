import streamlit as st
import json
import os

# 1. ç¶²é é…ç½®
st.set_page_config(page_title="114å¹´å°ˆå¸«èªå®šè‡ªæª¢-æ——è‰¦ç‰ˆ", layout="wide")

# å»ºç«‹æª”æ¡ˆå„²å­˜ç›®éŒ„
UPLOAD_DIR = "uploaded_evidence"
if not os.path.exists(UPLOAD_DIR):
    os.makedirs(UPLOAD_DIR)

# 2. æ ¸å¿ƒè³‡æ–™åº«ï¼šå®Œæ•´ 23 é …æ¢æ–‡ (å« 16 é …å¿…è©•) 
def get_full_criteria():
    return [
        # --- ç¬¬ä¸€ç« ï¼šæ•™å­¸è³‡æºèˆ‡çµ„ç¹”ç®¡ç† ---
        {"id": "1.1.1", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "è¨­æœ‰ç®¡ç†å°ˆè²¬å–®ä½ä¸¦è¨è«–åŸ·æ¥­èˆ‡æ¬Šç›Š", "c_level": "å‰¯é™¢é•·ç´šå¬é›†äººï¼Œé†«è­·å…±åŒçµ„æˆï¼Œæ¯3å€‹æœˆé–‹æœƒ1æ¬¡ã€‚", "check": ["çµ„ç¹”æ¶æ§‹åŠæˆå“¡åå–®", "è¿‘ä¸€å¹´4ä»½æœƒè­°ç´€éŒ„", "å‹å‹•æ¬Šç›Šç¶­è­·æªæ–½ç´€éŒ„"], "q": "å§”å“¡å•ï¼šå°ˆè²¬å–®ä½å¤šä¹…é–‹ä¸€æ¬¡æœƒï¼Ÿå¬é›†äººç´šåˆ¥ç‚ºä½•ï¼Ÿ"},
        {"id": "1.1.2", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "è¨‚å®šæ˜ç¢ºä¹‹åŸ·æ¥­å…§å®¹ä¸¦å…¬å‘Š", "c_level": "è¨‚å®šåˆ†ç§‘åŸ·æ¥­ç¯„åœï¼Œä¸”ä¸è¶…å‡ºæ³•è¦é™„è¡¨ç¯„åœã€‚", "check": ["å„åˆ†ç§‘åŸ·æ¥­è¦ç¯„", "å·¥ä½œå¥‘ç´„æ›¸(æˆ–æˆæ¬Šæ–‡ä»¶)", "é†«é™¢å…¬å‘Šå‘¨çŸ¥è­‰æ˜"], "q": "å¦‚ä½•ç¢ºä¿æ¥­å‹™é …ç›®ä¸è¶…å‡ºè¡›ç¦éƒ¨æœ€æ–°è¾¦æ³•ä¹‹é™„è¡¨ç¯„åœï¼Ÿ"},
        {"id": "1.1.3", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "è¨‚æœ‰é ç«‹é†«ç™‚æµç¨‹(PMP) SOP", "c_level": "å‰¯é™¢é•·å¬é›†å§”å“¡æœƒï¼Œé†«å¸«é ˆæ–¼24å°æ™‚å…§å®Œæˆæ ¸ç°½ã€‚", "check": ["é ç«‹é†«ç™‚æµç¨‹ SOP", "24å°æ™‚å…§é†«å¸«æ ¸ç°½ç´€éŒ„", "å§”å“¡æœƒåå–®"], "q": "åŸ·è¡Œ PMP å¾Œï¼Œç›£ç£é†«å¸«æ˜¯å¦ç¢ºå¯¦æ–¼ 24 å°æ™‚å…§è£œç°½åï¼Ÿ"},
        {"id": "1.1.4", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "å»ºç«‹ç—…æ­·æ›¸å¯«å¯©æŸ¥æ©Ÿåˆ¶", "c_level": "ä¸»æ²»é†«å¸«å°å°ˆå¸«ç—…æ­·è¨˜è¼‰çµ¦äºˆæŒ‡å°ã€‚", "check": ["ç—…æ­·æ›¸å¯«å¯©æŸ¥æ©Ÿåˆ¶è¦ç¯„", "é†«å¸«æŒ‡å°ç—•è·¡æˆ–å¯©æŸ¥ç´€éŒ„"], "q": "ä¸»æ²»é†«å¸«å¦‚ä½•å°ä½ çš„ç—…æ­·è¨˜è¼‰çµ¦äºˆå…·é«”æŒ‡å°ï¼Ÿ"},
        {"id": "1.1.5", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "æ˜ç¢ºä¹‹è‡¨åºŠåŸ·æ¥­å“è³ªç›£æ¸¬æ©Ÿåˆ¶", "c_level": "è¨‚æœ‰ç›£æ¸¬è¦ç¯„ã€è¾¦æ³•åŠæ©Ÿåˆ¶ä¸¦æä¾›ä½è­‰ã€‚", "check": ["å“è³ªç›£æ¸¬è¾¦æ³•", "ç›£æ¸¬æŒ‡æ¨™èˆ‡ä½è­‰è³‡æ–™"], "q": "é†«é™¢ç›®å‰å¦‚ä½•ç›£æ¸¬å°ˆå¸«çš„åŸ·æ¥­å“è³ªï¼Ÿ"},
        {"id": "1.1.6", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "å»ºç«‹å°ˆå¸«è€ƒæ ¸æ©Ÿåˆ¶", "c_level": "è€ƒæ ¸æ©Ÿåˆ¶ç”±é†«è­·éƒ¨é–€å…±åŒè² è²¬ã€‚", "check": ["å°ˆç§‘è­·ç†å¸«è€ƒæ ¸è¦ç¯„", "é†«è­·å…±åŒè€ƒæ ¸åŸ·è¡Œç´€éŒ„"], "q": "è€ƒè©•æ˜¯å¦ç¢ºå¯¦ç”±é†«ç™‚èˆ‡è­·ç†ä¸»ç®¡å…±åŒåŸ·è¡Œï¼Ÿ"},
        {"id": "1.2.1", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "å¦¥é©çš„è¨“ç·´å ´æ‰€", "c_level": "æä¾›å…¼é¡§éš±ç§ã€å®‰å…¨èˆ‡å­¸ç¿’ä¾¿åˆ©æ€§ä¹‹å ´æ‰€ã€‚", "check": ["è‡¨åºŠè¨“ç·´å ´æ‰€ç©ºé–“", "å·¥ä½œå®‰å…¨å¥åº·ç…§è­·ç­–ç•¥"], "q": "å¯¦åœ°è§€å¯Ÿå ´æ‰€æ˜¯å¦å…¼é¡§ç—…äººå®‰å…¨èˆ‡éš±ç§ï¼Ÿ"},
        {"id": "1.2.2", "is_mandatory": True, "chapter": "ç¬¬ä¸€ç« ", "title": "æä¾›è¨“ç·´å¿…é ˆä¹‹è¨­å‚™", "c_level": "æä¾›ç¶²è·¯å¹³å°ã€æ–‡ç»æª¢ç´¢ç­‰ç¡¬é«”èˆ‡å¹³å°ã€‚", "check": ["è¨“ç·´ç›¸é—œè¨­å‚™èˆ‡ç’°å¢ƒ", "ç¶²è·¯å­¸ç¿’å¹³å°èˆ‡æ–‡ç»åº«"], "q": "è‡¨åºŠå–®ä½æ˜¯å¦èƒ½éš¨æ™‚ä½¿ç”¨å­¸ç¿’å¹³å°èˆ‡æª¢ç´¢ç³»çµ±ï¼Ÿ"},
        {"id": "1.2.3", "is_mandatory": False, "chapter": "ç¬¬ä¸€ç« ", "title": "æä¾›é©ç•¶ä¹‹åœ–æ›¸ã€æœŸåˆŠä¸¦ç®¡ç†", "c_level": "æä¾›è¿‘5å¹´å…§åœ–æ›¸åŠæœŸåˆŠ(å«å¯¦è­‰ã€é†«å€«)ã€‚", "check": ["è³‡æºæ¸…å–®(å«é›»å­ç‰ˆ)", "æ–°è³¼å…¥å…¬å‘Šç´€éŒ„"], "q": "æ˜¯å¦äº†è§£æ–°è³¼åœ–æ›¸æœŸåˆŠä¹‹å…¬å‘Šç®¡é“ï¼Ÿ"},

        # --- ç¬¬äºŒç« ï¼šæ•™å­¸å¸«è³‡ã€åŸ¹è‚²èˆ‡ç¹¼çºŒæ•™è‚² ---
        {"id": "2.1.1", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "é†«å¸«å¸«è³‡æ‡‰å…·é©ç•¶è³‡æ ¼", "c_level": "å…·å°ˆç§‘é†«å¸«è³‡æ ¼ï¼Œå¯¦éš›å¾äº‹å°ˆç§‘å·¥ä½œè‡³å°‘2å¹´ã€‚", "check": ["é†«å¸«è­‰ç…§å½±æœ¬", "å¹´è³‡æœå‹™è­‰æ˜"], "q": "åƒèˆ‡åŸ¹è¨“ä¹‹æŒ‡å°é†«å¸«è³‡æ­·æ˜¯å¦æ»¿ 2 å¹´ï¼Ÿ"},
        {"id": "2.1.2", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å°ˆå¸«å¸«è³‡æ‡‰å…·é©ç•¶è³‡æ ¼", "c_level": "å…·å°ˆå¸«è³‡æ ¼ï¼Œå¯¦éš›å¾äº‹å°ˆå¸«å·¥ä½œè‡³å°‘2å¹´ã€‚", "check": ["å°ˆå¸«è­‰ç…§å½±æœ¬", "è‡¨åºŠæœå‹™å¹´è³‡è­‰æ˜"], "q": "æ“”ä»»æ•™å¸«ä¹‹å°ˆå¸«æ˜¯å¦å‡æ»¿ 2 å¹´å·¥ä½œè³‡æ­·ï¼Ÿ"},
        {"id": "2.1.3", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "é…ç½®æ¯”èˆ‡æ•™å­¸æˆæ•ˆè©•å€¼", "c_level": "é†«å¸«:å°ˆå¸«:å­¸å“¡æ¯”ä¾‹é ˆç¬¦åˆ 1:4:4ã€‚", "check": ["è‡¨åºŠé…ç½®çµ±è¨ˆè¡¨", "å¸«è³‡æ•™å­¸æˆæ•ˆè©•å€¼ç´€éŒ„"], "q": "ç›®å‰å„å–®ä½ä¹‹å¸«ç”Ÿæ¯”æ˜¯å¦ç¬¦åˆ 1:4:4 è¦ç¯„ï¼Ÿ"},
        {"id": "2.2.1", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å…·é«”å¸«è³‡åŸ¹è‚²åˆ¶åº¦ä¸¦è½å¯¦", "c_level": "æ˜è¨‚åŸ¹è¨“åˆ¶åº¦èˆ‡å¸«è³‡ç™¼å±•è¨ˆç•«ã€‚", "check": ["å¸«è³‡ç™¼å±•è¨ˆç•«æ›¸", "æ•™å¸«åƒèˆ‡é€²ä¿®ç´€éŒ„"], "q": "é†«é™¢å¦‚ä½•åŸ·è¡Œæ•™å¸«æ•™å­¸èƒ½åŠ›çš„åŸ¹è‚²ï¼Ÿ"},
        {"id": "2.2.2", "is_mandatory": False, "chapter": "ç¬¬äºŒç« ", "title": "å°ˆå¸«å¸«è³‡æ•™å­¸èƒ½åŠ›æå‡", "c_level": "è‡¨åºŠæ•™å¸«åƒèˆ‡èª²ç¨‹è‡³å°‘4å°æ™‚ï¼Œåƒèˆ‡ç‡100%ã€‚", "check": ["æ•™å¸«åƒèˆ‡æ•™å­¸èª²ç¨‹ç´€éŒ„", "èª²å¾Œæˆæ•ˆè©•ä¼°èˆ‡æª¢è¨"], "q": "æŒ‡å°æ•™å¸«ä»Šå¹´æ˜¯å¦çš†å®Œæˆ 4 å°æ™‚ä»¥ä¸Šè¨“ç·´ï¼Ÿ"},
        {"id": "2.2.3", "is_mandatory": True, "chapter": "ç¬¬äºŒç« ", "title": "å°ˆå¸«ç¹¼çºŒæ•™è‚²è¨“ç·´åˆ¶åº¦", "c_level": "è¦åŠƒæ¯å¹´è‡³å°‘è¾¦ç†20å°æ™‚æ•™è‚²èª²ç¨‹ã€‚", "check": ["å¹´åº¦ç¹¼çºŒæ•™è‚²è¨ˆç•«", "èƒ½åŠ›é€²éšåˆ¶åº¦åŸ·è¡Œç´€éŒ„"], "q": "èª²ç¨‹å®‰æ’æ˜¯å¦è¶³ä»¥ç¶­æŒå°ˆå¸«è­‰ç…§æ•ˆæœŸï¼Ÿ"},

        # --- ç¬¬ä¸‰ç« ï¼šæ•™å­¸è¨“ç·´è¨ˆç•«èˆ‡åŸ·è¡Œæˆæœ ---
        {"id": "3.1.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "æ•™å­¸è¨“ç·´è¨ˆç•«å…·é«”å¯è¡Œ", "c_level": "å«ç›®çš„ã€èª²ç¨‹ã€å“è³ªç¶­è­·ã€ç›£æ¸¬åŠè©•å€¼ã€‚", "check": ["2023-2026 åŸ¹è¨“è¨ˆç•«æ›¸", "å„åˆ†ç§‘åŸ¹è¨“èª²ç¨‹æ¶æ§‹", "è¨ˆç•«æª¢è¨æœƒè­°ç´€éŒ„"], "q": "è«‹èªªæ˜è¨“ç·´è¨ˆç•«å¦‚ä½•ç¢ºä¿æ•™å­¸å“è³ªï¼Ÿ"},
        {"id": "3.1.2", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "é©ç•¶å®‰æ’æ•™å­¸èª²ç¨‹èˆ‡æ´»å‹•", "c_level": "ä¾èƒ½åŠ›å®‰æ’èª²ç¨‹ï¼Œåˆç†å…¼é¡§å­¸ç¿’èˆ‡å·¥ä½œã€‚", "check": ["æ•™å­¸æ´»å‹•æ™‚ç¨‹è¡¨", "é–‹è¨“èªªæ˜æœƒç°¡å ±æˆ–ç°½åˆ°", "è£œè¨“è£œæ•‘æ©Ÿåˆ¶ç´€éŒ„"], "q": "å¦‚ä½•ç¢ºä¿è¨“ç·´æ™‚æ•¸ä¸è¢«è‡¨åºŠå·¥ä½œæ’æ“ ï¼Ÿ"},
        {"id": "3.2.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´èª²ç¨‹ç¬¦åˆæ³•è¦è¦å®š", "c_level": "å…§å®¹é ˆç¬¦åˆå°ˆç§‘è­·ç†å¸«åˆ†ç§‘åŠç”„å¯©è¾¦æ³•ã€‚", "check": ["æ•™å­¸è¨ˆç•«æ›¸æ³•è¦æ¯”å°", "æ•™æã€ç°½åˆ°èˆ‡æˆæœè©•å€¼"], "q": "å¦‚ä½•æ ¸å°ç›®å‰çš„èª²ç¨‹ç¬¦åˆä¸­å¤®æ³•è¦è¦æ±‚ï¼Ÿ"},
        {"id": "3.2.2", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è‡¨åºŠå¯¦å‹™è¨“ç·´è½å¯¦åŸ·è¡Œ", "c_level": "åæ˜ å­¸ç¿’ç›®æ¨™ï¼Œå…·æª¢è¨æ”¹å–„æ©Ÿåˆ¶ã€‚", "check": ["å¯¦å‹™è¨“ç·´ç”¢ç”Ÿä¹‹æˆæœ", "æª¢è¨åŠæ”¹å–„ä¹‹è­‰æ“š"], "q": "è€å¸«å¦‚ä½•åœ¨è‡¨åºŠä¸Šç¢ºèªå­¸å“¡çš„å­¸ç¿’æˆæ•ˆï¼Ÿ"},
        {"id": "3.3.1", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "æœ‰å›é¥‹æ©Ÿåˆ¶èˆ‡åæ˜ ç®¡é“", "c_level": "æ•™å¸«å³æ™‚å›é¥‹ä¸¦è¨˜éŒ„ï¼Œä¿éšœå­¸å“¡æ¬Šç›Šã€‚", "check": ["å¸«ç”Ÿè¼”å°ç´€éŒ„", "å­¸å“¡åæ˜ å•é¡Œæºé€šè­‰æ˜"], "q": "å­¸å“¡é‡åˆ°ä¸åˆç†å¾…é‡æ™‚æœ‰å“ªäº›åæ˜ çª—å£ï¼Ÿ"},
        {"id": "3.3.2", "is_mandatory": False, "chapter": "ç¬¬ä¸‰ç« ", "title": "å°æ–¼æ•™å¸«å¤šå…ƒåŒ–è©•ä¼°æ©Ÿåˆ¶", "c_level": "è¨‚æœ‰æ•™å­¸æˆæ•ˆè©•ä¼°æ©Ÿåˆ¶ä¸¦å¯¦éš›åŸ·è¡Œã€‚", "check": ["è©•ä¼°æ•™å¸«ä¹‹æ©Ÿåˆ¶æ–‡ä»¶", "å›é¥‹èˆ‡è¼”å°æ”¹å–„ç´€éŒ„"], "q": "å­¸å“¡å¦‚ä½•è©•ä¼°è€å¸«ï¼Ÿçµæœæ˜¯å¦çµ¦äºˆè€å¸«å»ºè­°ï¼Ÿ"},
        {"id": "3.3.3", "is_mandatory": False, "chapter": "ç¬¬ä¸‰ç« ", "title": "å­¸å“¡è¨“ç·´æˆæœåˆ†æèˆ‡æ”¹å–„", "c_level": "å¤šå…ƒç®¡é“è©•ä¼°çµæœä¸¦åˆ†æã€è¼”å°å­¸å“¡ã€‚", "check": ["è¨“ç·´æˆæœåˆ†æå ±å‘Š", "æˆæœä¸ä½³è€…è¼”å°ç´€éŒ„"], "q": "è‹¥å­¸å“¡é™¢å…§æ¸¬è©¦ä¸éï¼Œæœ‰ä»€éº¼è£œå¼·è¼”å°æªæ–½ï¼Ÿ"},
        {"id": "3.3.4", "is_mandatory": True, "chapter": "ç¬¬ä¸‰ç« ", "title": "è¨“ç·´è¨ˆç•«æˆæ•ˆè©•ä¼°", "c_level": "è¨‚æœ‰è©•å€¼è¨ˆç•«ä¸”æ¯å¹´æª¢è¨(å«è€ƒç…§ç‡)ã€‚", "check": ["è¨ˆç•«è©•å€¼åˆ†æå ±å‘Š", "å¹´åº¦è€ƒç…§é€šéç‡çµ±è¨ˆ", "æ”¹å–„æªæ–½è¿½è¹¤è¡¨"], "q": "å»å¹´è€ƒç…§ç‡å¦‚ä½•ï¼Ÿå¦‚ä½•ä¾æ­¤ä¿®è¨‚æ•™å­¸è¨ˆç•«ï¼Ÿ"}
    ]

# 3. æª”æ¡ˆå­˜å–é‚è¼¯
SAVE_FILE = 'progress.json'
def load_progress():
    if os.path.exists(SAVE_FILE):
        try:
            with open(SAVE_FILE, 'r', encoding='utf-8') as f: return json.load(f)
        except: return {}
    return {}

def save_progress(progress):
    with open(SAVE_FILE, 'w', encoding='utf-8') as f: json.dump(progress, f, ensure_ascii=False)

# --- UI ä»‹é¢ ---
st.title("ğŸ›¡ï¸ 114å¹´åº¦å°ˆç§‘è­·ç†å¸«è¨“ç·´é†«é™¢èªå®š-çµ‚æ¥µå¯¦æˆ°ç³»çµ±")
st.markdown("æœ¬ç³»çµ±å·²è£œé½Š **23 é …æ¢æ–‡**ï¼Œä¸¦å•Ÿç”¨**æ¨™æº–åŒ–è‡ªå‹•å‘½åä¸Šå‚³**èˆ‡**å¤šé‡é€£çµåŠŸèƒ½**ã€‚")

data = get_full_criteria()
saved_progress = load_progress()
user_data = {}

tab_chk, tab_files = st.tabs(["ğŸ“‹ æ¢æ–‡è‡ªæª¢èˆ‡ä¸Šå‚³", "ğŸ“‚ æª”æ¡ˆåº«ç®¡ç†"])

with tab_chk:
    for chap in ["ç¬¬ä¸€ç« ", "ç¬¬äºŒç« ", "ç¬¬ä¸‰ç« "]:
        st.subheader(f"ğŸ“ {chap}")
        for item in [d for d in data if d['chapter'] == chap]:
            badge = " (å¿…)" if item['is_mandatory'] else ""
            with st.expander(f"{item['id']} {item['title']}{badge}"):
                st.write(f"**ã€Cç­‰ç´šæ¨™æº–ã€‘**ï¼š{item['c_level']}")
                st.warning(f"ğŸ¤ {item['q']}")
                
                old_data = saved_progress.get(item['id'], {"score": "D", "res": "æœªæŒ‡æ´¾", "checks": [], "links": {}})
                
                # é¸é … Aï¼šè² è²¬äººæŒ‡æ´¾
                roles = ["æœªæŒ‡æ´¾", "è¡Œæ”¿çµ„", "æ•™å­¸çµ„", "è‡¨åºŠçµ„", "å­¸è¡“çµ„é•·", "å…¶ä»–"]
                def_idx = roles.index(old_data['res']) if old_data['res'] in roles else 0
                selected_role = st.selectbox(f"ğŸ‘¤ è² è²¬äºº ({item['id']})", roles, index=def_idx, key=f"sel_{item['id']}")
                final_res = selected_role if selected_role != "å…¶ä»–" else st.text_input("âœï¸ å§“å", key=f"res_{item['id']}", value=old_data['res'] if old_data['res'] not in roles else "")

                # é¸é … Bï¼šä½è­‰æ¸…å–®å‹¾é¸ (ä¿®å¾©å€)
                st.write("**ğŸ“‘ ä½è­‰ç´°é …æ ¸å°ï¼š**")
                current_checks = []
                for i, check_item in enumerate(item['check']):
                    old_checked = old_data.get("checks", [])[i] if i < len(old_data.get("checks", [])) else False
                    is_checked = st.checkbox(check_item, value=old_checked, key=f"chk_{item['id']}_{i}")
                    current_checks.append(is_checked)

                # é¸é … Cï¼šæª”æ¡ˆè‡ªå‹•åŒ–å‘½åä¸Šå‚³
                st.write("**ğŸ“¤ ç›´æ¥ä¸Šå‚³ (ç³»çµ±å°‡è‡ªå‹•é‡å‘½åç‚ºæ¨™æº–æ ¼å¼)ï¼š**")
                files = st.file_uploader(f"é¸æ“‡æª”æ¡ˆ", accept_multiple_files=True, key=f"up_{item['id']}")
                if files:
                    for f in files:
                        ext = os.path.splitext(f.name)[1]
                        # æ¨™æº–åŒ–å‘½åï¼š1.1.3_é ç«‹é†«ç™‚æµç¨‹_2026å‚™è©•ç”¨.pdf
                        base_name = f"{item['id']}_{item['title']}_2026å‚™è©•ç”¨"
                        new_name = f"{base_name}{ext}"
                        # è™•ç†é‡è¤‡åç¨±
                        idx = 1
                        while os.path.exists(os.path.join(UPLOAD_DIR, new_name)):
                            new_name = f"{base_name}_{idx}{ext}"
                            idx += 1
                        
                        file_path = os.path.join(UPLOAD_DIR, new_name)
                        with open(file_path, "wb") as save_f:
                            save_f.write(f.getbuffer())
                    st.success(f"å·²å­˜å…¥ï¼š{new_name}")

                # é¸é … Dï¼šå¤šé‡é€£çµç®¡ç†
                st.write("**ğŸ”— å¤šé‡ URL é€£çµ (ç”¨è‹±æ–‡é€—è™Ÿ , åˆ†éš”)ï¼š**")
                old_links = old_data.get("links", {})
                raw_links = st.text_input("è²¼ä¸Šé€£çµ", key=f"lnk_{item['id']}", value=old_links.get("all", ""), placeholder="URL1, URL2...")
                if raw_links:
                    l_list = [l.strip() for l in raw_links.split(",") if l.strip()]
                    cols = st.columns(len(l_list))
                    for l_idx, link in enumerate(l_list):
                        with cols[l_idx]:
                            st.link_button(f"ğŸ“‚ æª”æ¡ˆ{l_idx+1}", link, use_container_width=True)

                # é¸é … Eï¼šè©•åˆ†ç­‰ç´š
                score = st.radio("è‡ªè©•ç­‰ç´š", ["A", "B", "C", "D"], index=["A", "B", "C", "D"].index(old_data['score']), key=f"r_{item['id']}", horizontal=True)
                
                user_data[item['id']] = {
                    "score": score, 
                    "res": final_res, 
                    "checks": current_checks, 
                    "links": {"all": raw_links}
                }

    if st.button("ğŸ’¾ å„²å­˜è‡ªæª¢é€²åº¦"):
        save_progress(user_data)
        st.toast("é€²åº¦å·²å„²å­˜ï¼")

with tab_files:
    st.subheader("ğŸ“‚ æ¨™æº–åŒ–å‚™è©•æª”æ¡ˆåº«")
    all_files = os.listdir(UPLOAD_DIR)
    if all_files:
        for f in sorted(all_files):
            st.write(f"ğŸ“„ {f}")
    else:
        st.write("ç›®å‰å°šç„¡ä¸Šå‚³æª”æ¡ˆã€‚")

# 4. å´é‚Šæ¬„èªå®šé‚è¼¯ [cite: 17]
passed_count = sum(1 for d in user_data.values() if d['score'] in ['A', 'B', 'C'])
total_count = len(data)
pass_rate = (passed_count / total_count) * 100
mandatory_failed = [id for id, d in user_data.items() if any(i['id'] == id and i['is_mandatory'] for i in data) and d['score'] == 'D']

st.sidebar.metric("é”æˆç‡", f"{pass_rate:.1f}%")
if mandatory_failed:
    st.sidebar.error(f"âŒ ä¸åˆæ ¼ï¼šå¿…è¦æ¢æ–‡ D ({', '.join(mandatory_failed)})")
elif pass_rate >= 90:
    st.sidebar.success("âœ… ç¬¦åˆé€šéé–€æª»")
else:
    st.sidebar.warning(f"âš ï¸ é”æˆç‡ä¸è¶³ 90% (ç›®å‰ {passed_count}/{total_count})")

st.sidebar.divider()
st.sidebar.info("ğŸ’¡ æé†’ï¼šå¿…è¦æ¢æ–‡é ˆ 100% é” C ä»¥ä¸Šï¼Œä¸”ç¸½é”æˆç‡éœ€é” 90% ä»¥ä¸Š [cite: 17]ã€‚")
